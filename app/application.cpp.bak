#include <user_config.h>
#include <SmingCore/SmingCore.h>
#include <Libraries/DHT/DHT.h>
#include <Libraries/BMP180/BMP180.h>
#include <Libraries/Adafruit_PCD8544/Adafruit_PCD8544.h>

/* Определение выводов */
#define LCD_SCLK 5
#define LCD_DIN  15
#define LCD_DC   13
#define LCD_CS   12
#define LCD_RST  14
#define DHT_PIN	 0
#define BMP_SCL  2
#define BMP_SDA  4

/* Создание объектов */
Adafruit_PCD8544 display = Adafruit_PCD8544(LCD_SCLK, LCD_DIN, LCD_DC, LCD_CS, LCD_RST);
DHT dht(DHT_PIN);
BMP180 barometer;
Timer sensorsUpdate;
Timer webRequest;
Timer displayRefresh;
NtpClient *ntpClient;
HttpClient httpClient;
int sensorValue = 0;

/* Переменные для хранения значений */
float  temp         = 0.0;
float  humidity     = 0.0;
float  pressure     = 0.0;
String wifi_ssid    = "Symrak";
String wifi_psw     = "s1PKo1Dj";
String ntp_srv      = "pool.ntp.org";
String web_srv		= "http://m.meteopost.com/weather/kiev/";
int	   sns_interval = 5000;		// каждые 5 секунд
int    dsp_interval = 1000;		// каждую 1 секунду
int    ntp_interval = 1800;		// каждые 30 минут (в секундах)
int	   web_interval = 1800000;	// каждые 30 минут (в милисекундах)
double timezone     = -2.0;

void dhtInit()
{
	WDT.enable(false);
	delay(1000);
	dht.begin();
	WDT.alive();
}
void dhtGet(bool uart)
{
	humidity = dht.readHumidity();
	temp = dht.readTemperature();

	if(isnan(temp))
		temp = 0.0;
	if(isnan(humidity))
		humidity = 0.0;

	if(uart)
	{
		if (isnan(temp) || isnan(humidity))
		{
			Serial.println("Failed to read from DHT");
		}
		else
		{
			Serial.print("Humidity: ");
			Serial.print(humidity);
			Serial.print("%, Temperature: ");
			Serial.print(temp);
			Serial.write(176);
			Serial.print("C\n");
		}
	}
}
void bmpInit()
{
	Wire.pins(BMP_SCL, BMP_SDA);
	Wire.begin();
	if(!barometer.EnsureConnected())
		Serial.println("Could not connect to BMP180.");
	barometer.Initialize();
}
void bmpGet(bool uart, bool temp)
{
	float bmpTemp = 0.0;
	long  paPressure = 0.0;

	paPressure = barometer.GetPressure();
	if(isnan(paPressure))
		paPressure = 0.0;

	if(temp)
		bmpTemp = barometer.GetTemperature();

	pressure = paPressure/133.3;

	if(uart)
	{
		Serial.print("Pressure: ");
		Serial.print(paPressure);
		Serial.print("Pa");
		Serial.print(", ");
		Serial.print(pressure);
		Serial.print("mm");

		if(!temp)
			Serial.print("\n");
		else
		{
			Serial.print(", Temperature: ");
			Serial.print(bmpTemp);
			Serial.write(176);
			Serial.print("C\n");
		}
	}
}
void sensorsGet()
{
	dhtGet(false);
	bmpGet(false, false);
}
void displayInit()
{
	display.begin();
	display.setContrast(0);
	display.clearDisplay();
	display.setRotation(0);

	display.setTextSize(1);
	display.setTextColor(BLACK);
	display.setCursor(0,0);
}
void displayContent()
{
	display.clearDisplay();

	display.print("T: ");
	display.print(temp);
	display.println("C");

	display.print("H: ");
	display.print(humidity);
	display.println("%");

	display.print("P: ");
	display.print(pressure);
	display.println("mm\n");

	DateTime currentDateTime = SystemClock.now(eTZ_UTC);
	display.println(currentDateTime.toShortDateString());
	display.println(currentDateTime.toShortTimeString(true));
	display.display();
}
void timeReceived(NtpClient& client, time_t timestamp)
{
	SystemClock.setTime(timestamp);
}

void weatherParse(HttpClient& client, bool successful)
{
	if (successful)
		Serial.println("Success get");
	else
		Serial.println("Failed");

	String response = client.getResponseString();
	Serial.println("Server response: \n" + response + "\n");
}
void weatherRequest()
{
	WDT.enable(false);
	if (httpClient.isProcessing())
	{
		WDT.alive();
		return;
	}
	WDT.enable(false);
	httpClient.downloadString(web_srv, weatherParse);
	WDT.alive();
}
void wifiInit()
{
	WifiAccessPoint.enable(false);
	WifiStation.config(wifi_ssid, wifi_psw);
	WifiStation.enable(true);
}
void wifiConnectOk()
{
	ntpClient = new NtpClient(ntp_srv, ntp_interval, timeReceived);

	//webRequest.initializeMs(web_interval, weatherRequest).start();
}
void wifiConnectFail()
{
	WifiStation.waitConnection(wifiConnectOk, 10, wifiConnectFail);
}

void init()
{
	//WDT.enable(false);
	//WDT.alive();
	//system_soft_wdt_stop();
	//system_soft_wdt_restart();

	spiffs_mount();

	WDT.alive();

	Serial.begin(SERIAL_BAUD_RATE);
	Serial.systemDebugOutput(true);

	SystemClock.setTimeZone(timezone);

	dhtInit();
	bmpInit();

	displayInit();

	WDT.alive();

	sensorsUpdate.initializeMs(sns_interval, sensorsGet).start();
	displayRefresh.initializeMs(dsp_interval, displayContent).start();

	wifiInit();

	WDT.alive();

	WifiStation.waitConnection(wifiConnectOk, 20, wifiConnectFail);
}
